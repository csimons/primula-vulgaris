/*
 * Primula.java
 * authors: Manfred Jaeger,Jani Saijos,Mads Thrane
 * Copyright (C) 2005 Aalborg University
 *
 * contact:
 * jaeger@cs.aau.dk   http://www.cs.aau.dk/~jaeger/Primula.html
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 */

package RBNgui;

import javax.swing.*;
import java.awt.event.*;
import java.awt.*;
import java.io.*;
import java.util.zip.*;


import RBNpackage.*;
import RBNio.*;
import RBNinference.*;
import RBNExceptions.*;
import RBNutilities.*;

//import myio.*;

import edu.ucla.belief.ui.primula.*;
import edu.ucla.belief.ace.PrimulaSystemSnapshot;

public class Primula extends JFrame implements PrimulaUIInt, ActionListener, ItemListener, KeyListener {

    public static final Color COLOR_YELLOW          = new Color(189, 187, 127);
    public static final Color COLOR_YELLOW_SELECTED = new Color(249, 245, 107);//58,57,98
    public static final Color COLOR_BLUE            = new Color(114, 122, 136);//218,17,53
    public static final Color COLOR_BLUE_SELECTED   = new Color(162, 195, 255);//218,36,100
    public static final Color COLOR_GREEN           = new Color(129, 166, 135);//129,22,65
    public static final Color COLOR_GREEN_SELECTED  = new Color(128, 255, 128);//129,93,90
    // public static final Color COLOR_RED             = new Color(189, 127, 127);//0,33,74
    public static final Color COLOR_RED             = new Color(159, 135, 135);//0, 15, 63
    public static final Color COLOR_RED_SELECTED    = new Color(255, 181, 181);//0, 29, 100

    private JMenuBar mb               = new JMenuBar();
    private JMenu editMenu            = new JMenu("Input");
    private JMenuItem evModule        = new JMenuItem("Start Inference Module");
    private JMenuItem loadOrdered     = new JMenuItem("Create OrderedStruc");
    private JMenuItem loadSparse      = new JMenuItem("Load Relational Structure");
    private JMenuItem startBavaria    = new JMenuItem("Start Bavaria");
    private JMenu runmenu             = new JMenu("Run");
    private JMenuItem constructCPTBN    = new JMenuItem("Construct Bayesian Network");
//     private JMenuItem constructPFBN    = new JMenuItem("Construct PF Network");


    private JMenuItem itemInvokeSamIam= new JMenuItem("Open SamIam");
    private JMenuItem itemForgetAll   = new JMenuItem("Reset external software locations");
    private JMenuItem exit            = new JMenuItem("Exit");
    private JMenu optionsmenu         = new JMenu("Options");
    private JMenu rbnSystems          = new JMenu("Bayes Network System");
    private JMenu decMode             = new JMenu("Decompose Mode");
    private JMenu helpmenu            = new JMenu("Help");
    private JMenuItem itemabout           = new JMenuItem("About Primula");
    //    private JMenu sampleOrd            = new JMenu("Sampling Order");
    private static JTextArea messageArea  = new JTextArea(15, 20);
    private JLabel rstsrcLabel            = new JLabel("RST source:");
    private JLabel rstsrc                 = new JLabel("");
    private JLabel rbnsrcLabel            = new JLabel("RBN source:");
    private JLabel bnoutLabel             = new JLabel("BN output:");
    private JTextField rbnfilename        = new JTextField(15);
    private JTextField bnoutfilename      = new JTextField(15);
    private JButton loadRBN               = new JButton("Browse");
    private JButton saveBN                = new JButton("Browse");
    private JScrollPane scrollPane        = new JScrollPane();
    private JFileChooser fileChooser      = new JFileChooser( "." );
    private javax.swing.filechooser.FileFilter myFilterRST, myFilterRBN;//keith cascio 20061201
    private String messages               = "";
    private static boolean isBavariaOpen  = false;
    private static boolean isEvModuleOpen = false;
    private boolean strucEdited           = false; //edited in bavaria

    private JPanel srcLabels      = new JPanel(new GridLayout(3, 1));
    private JPanel rbnInputFields = new JPanel(new BorderLayout());
    private JPanel bnoutInputFields  = new JPanel(new BorderLayout());
    private JPanel inputFields    = new JPanel(new GridLayout(3, 1));
    private JPanel southPanel     = new JPanel(new BorderLayout());

    public static final int CF_NOR = 0;
    public static final int CF_MEAN = 1;
    public static final int CF_INVSUM = 2;
    public static final int CF_ESUM = 3;

    public static final int OPTION_NOT_EVIDENCE_CONDITIONED = 0;
    public static final int OPTION_EVIDENCE_CONDITIONED     = 1;
    public static final int OPTION_NOT_QUERY_SPECIFIC       = 0;
    public static final int OPTION_QUERY_SPECIFIC           = 1;
    //public static final int OPTION_NOT_MINIMIZE_NETWORK     = 0;
    //public static final int OPTION_MINIMIZE_NETWORK         = 1;
    public static final int OPTION_DECOMPOSE  = 0;
    public static final int OPTION_DECOMPOSE_DETERMINISTIC        = 1;
    public static final int OPTION_NOT_DECOMPOSE  = 2;
    public static final int OPTION_NOT_ELIMINATE_ISOLATED_ZERO_NODES  = 0;
    public static final int OPTION_ELIMINATE_ISOLATED_ZERO_NODES      = 1;
    public static final int OPTION_NO_LAYOUT = 0;
    public static final int OPTION_LAYOUT = 1;
    public static final int OPTION_JAVABAYES                = 0;
    public static final int OPTION_HUGIN                    = 1;
    public static final int OPTION_NETICA                   = 2;
    public static final int OPTION_SAMIAM                   = 3;

		private JRadioButtonMenuItem javaBayes;
		private JRadioButtonMenuItem hugin;
		private JRadioButtonMenuItem netica;
		private JRadioButtonMenuItem samiam;
		private JRadioButtonMenuItem decnone;
		private JRadioButtonMenuItem decstandard;
		private JRadioButtonMenuItem decdet;
// 		private JRadioButtonMenuItem ordforward;
// 		private JRadioButtonMenuItem ordripple;

		private JCheckBoxMenuItem querySpecific;
		private JCheckBoxMenuItem evidenceConditioned;
		private JCheckBoxMenuItem layoutItem;
		private JCheckBoxMenuItem eliminateIsolatedZeroNodes;
    //		private JCheckBoxMenuItem adaptiveSampling;


    protected int querymode = OPTION_NOT_QUERY_SPECIFIC ;
    protected int evidencemode = OPTION_EVIDENCE_CONDITIONED;
    protected int decomposemode = OPTION_DECOMPOSE;
    protected int isolatedzeronodesmode = OPTION_ELIMINATE_ISOLATED_ZERO_NODES;
    protected int layoutmode = OPTION_LAYOUT;
    protected int bnsystem = OPTION_SAMIAM;
//    protected int adaptivemode = OPTION_NOT_SAMPLE_ADAPTIVE;
//    protected int sampleordmode = OPTION_SAMPLEORD_FORWARD;
//    protected int samplelogmode = OPTION_SAMPLELOG;

    private final String STRUCTURE_MODIFIED = "Current structure modified. Continue?";
    private final String INST_AND_QUERIES_LOST = "This action will cause current instantiations and queries to be lost. Continue?";

    /** @author keith cascio
	@since  20061105 */
    public static final String  STR_OPTION_DEBUG = "debug";
    public static       boolean FLAG_DEBUG       = false;

    protected File srsfile;
    protected File rbnfile;
    protected File bnoutfile;
    protected EvidenceModule evidenceModule;
    protected RelStruc rels;
    protected RBN rbn;
    protected Instantiation inst = new Instantiation();
    protected AtomList queryatoms = new AtomList();

    /** @author keith cascio
	@since 20060728 */
    public RBN getRBN(){
    	return Primula.this.rbn;
    }

    /** @author keith cascio
	@since 20060728 */
    public RelStruc getRels(){
    	return Primula.this.rels;
    }

    /** @author keith cascio
	@since 20060515 */
    public PrimulaSystemSnapshot snapshot(){
    	if( (this.rbn == null) || (this.rels == null) ) return null;

    	PrimulaSystemSnapshot ret = new PrimulaSystemSnapshot(
	    this.rbn,
	    this.rels,
	    this.inst,
	    this.queryatoms,
	    this.srsfile,
	    this.rbnfile,
	    this.bnoutfile,
	    this.querymode,
	    this.evidencemode,
	    this.decomposemode,
	    this.isolatedzeronodesmode,
	    this.layoutmode,
	    this.bnsystem,
	    this.getPreferences().getACESettings()
    	);
    	return ret;
    }

    /** @author keith cascio
	@since  20061201 */
    public void setDecomposeMode( int mode ){
         Primula.this.decomposemode = mode;
    }

    private SamiamManager mySamiamManager;
    private boolean myFlagSystemExitEnabled = true;
    public static final String STR_FILENAME_LOGO = "small_logo.jpg";
    private Preferences myPreferences;
    private JMenuItem btnDebugAceCompile = new JMenuItem( "DEBUG ace compile" );

    /**
       @author Keith Cascio
       @since 040804
    */
    public void setTheSamIamUI( edu.ucla.belief.ui.primula.SamiamUIInt ui ){
    	//THE_SAMIAM_UI = ui;
    	getSamiamManager().setSamiamUIInstance( ui );
    }

    /**
       @author Keith Cascio
       @since 050404
    */
    public SamiamManager getSamiamManager(){
	if( mySamiamManager == null ) mySamiamManager = new SamiamManager( this );
	return mySamiamManager;
    }

    /** @author keith cascio
	@since 20060602 */
    public void forgetAll(){
    	if( myPreferences != null ) myPreferences.forgetAll();
    	if( mySamiamManager != null ) mySamiamManager.forgetAll();
    	if( evidenceModule != null ) evidenceModule.forgetAll();
    }

    /**
       @author Keith Cascio
       @since 040804
    */
    public JFrame asJFrame(){
	return this;
    }

    /**
       @arg flag Sets whether the JVM should terminate when the user closes Primula.  Set this to false if you call Primula from another Java program and you want to prevent Java from exiting when the user exits Primula.
       @since 040804
    */
    public void setSystemExitEnabled( boolean flag ){
	myFlagSystemExitEnabled = flag;
    }

    /**
       @ret true if a user action that closes Primula will cause the JVM to terminate as well.
       @since 040804
    */
    public boolean isSystemExitEnabled(){
	return myFlagSystemExitEnabled;
    }

    /**
       @author Keith Cascio
       @since 040804
    */
    public void exitProgram(){
	myPreferences.saveOptionsToFile();
	if( isSystemExitEnabled() ) System.exit( 0 );
	else setVisible( false );
    }

    /**
       @author Keith Cascio
       @since 040804
    */
    private void init()
    {
        //ImageIcon icon = new ImageIcon("small_logo.jpg");
        ImageIcon icon = getIcon( STR_FILENAME_LOGO );

        if( icon.getImageLoadStatus() == MediaTracker.COMPLETE ){//image ok
            this.setIconImage(icon.getImage());
        }
        this.setTitle("Primula");
        this.pack();

        myPreferences = new Preferences( true );
    }

    /**
       @author Keith Cascio
       @since 042104
    */
    public ImageIcon getIcon( String fileName ){
        ClassLoader myLoader = this.getClass().getClassLoader();
        java.net.URL urlImage = myLoader.getResource( fileName );
        if( urlImage == null ){
            System.err.println( "Warning: loader.getResource(\""+fileName+"\") failed." );
            return new ImageIcon( fileName );
        }
        else return new ImageIcon( urlImage );
    }

    /**
       @author Keith Cascio
       @since 040504
    */
    public String makeNetworkName()
    {
	if( bnoutfile == null ) return makeAlternateName();
	else return bnoutfile.getPath();
    }

    /**
       @author Keith Cascio
       @since 040504
    */
    public String makeAlternateName()
    {
	String strRST = (rstsrc == null ) ? "no_RST" : rstsrc.getText();
	if( strRST.length() < (int)1 ) strRST = "no_RST";
	String strRBN = (rbnfilename == null ) ? "no_RBN" : rbnfilename.getText();
	if( strRBN.length() < (int)1 ) strRBN = "no_RBN";

	return pluckNameFromPath( strRST ) + "_" + pluckNameFromPath( strRBN ) + ".net";
    }

    /**
       @author Keith Cascio
       @since 040504
    */
    public static String pluckNameFromPath( String path )
    {
	int index0 = path.lastIndexOf( File.separator );
	if( index0 < (int)0 ) index0 = (int)0;
	else ++index0;
	int index1 = path.lastIndexOf( "." );
	if( index1 < (int)0 ) index1 = path.length();
	return path.substring( index0, index1 );
    }

    /**
       @author Keith Cascio
       @since 040804
    */
    public edu.ucla.belief.ui.primula.SamiamUIInt getSamIamUIInstanceThis(){
    	//edu.ucla.belief.ui.primula.SamiamUIInt ui = getSamIamUIInstance();
    	//if( ui != null ) ui.setPrimulaUIInstance( this );
    	//return ui;
    	return getSamiamManager().getSamIamUIInstance();
    }

    /**
       @author Keith Cascio
       @since 050404
    */
    public Preferences getPreferences(){
    	return myPreferences;
    }

    public Primula()
    {
	//Creates the menus

	editMenu.add(loadOrdered);
	editMenu.add(loadSparse);
	editMenu.add(startBavaria);
	mb.add(editMenu);
	runmenu.add(evModule);
	runmenu.add(constructCPTBN);
// 	runmenu.add(constructPFBN);
	runmenu.add(itemInvokeSamIam);
	if( Primula.FLAG_DEBUG ) runmenu.add( btnDebugAceCompile );//keith cascio 20060516
	runmenu.add(exit);
	mb.add(runmenu);

	ButtonGroup rbnGroup = new ButtonGroup();
	javaBayes = new JRadioButtonMenuItem("Java Bayes");
	//javaBayes.setSelected(true);
	rbnGroup.add(javaBayes);
	rbnSystems.add(javaBayes);
	hugin = new JRadioButtonMenuItem("Hugin");
	rbnGroup.add(hugin);
	rbnSystems.add(hugin);
	netica = new JRadioButtonMenuItem("Netica");
	rbnGroup.add(netica);
	rbnSystems.add(netica);
	samiam = new JRadioButtonMenuItem("To SamIam");
	samiam.setSelected(true);
	rbnGroup.add(samiam);
	rbnSystems.add(samiam);

	ButtonGroup decmGroup = new ButtonGroup();
	decnone =  new JRadioButtonMenuItem("none");
	decmGroup.add(decnone);
	decMode.add(decnone);
	decstandard =  new JRadioButtonMenuItem("normal");
	decstandard.setSelected(true);
	decmGroup.add(decstandard);
	decMode.add(decstandard);
	decdet =  new JRadioButtonMenuItem("deterministic");
	decmGroup.add(decdet);
	decMode.add(decdet);

// 	ButtonGroup sOrdGroup = new ButtonGroup();
// 	ordforward =  new JRadioButtonMenuItem("forward");
// 	ordforward.setSelected(true);
// 	sOrdGroup.add(ordforward);
// 	sampleOrd.add(ordforward);
// 	ordripple =  new JRadioButtonMenuItem("ripple");
// 	sOrdGroup.add(ordripple);
// 	sampleOrd.add(ordripple);


	JMenu inferenceOptions = new JMenu("Construction Mode");
	querySpecific = new JCheckBoxMenuItem("Query specific");
	inferenceOptions.add(querySpecific);
	evidenceConditioned = new JCheckBoxMenuItem("Evidence conditioned");
	evidenceConditioned.setSelected(true);
	inferenceOptions.add(evidenceConditioned);
	//     JCheckBoxMenuItem deterministicNetwork = new JCheckBoxMenuItem("Build deterministic BN",false);
	//     inferenceOptions.add(deterministicNetwork);
	layoutItem = new JCheckBoxMenuItem("Skip layout",false);
	inferenceOptions.add(layoutItem);
	eliminateIsolatedZeroNodes = new JCheckBoxMenuItem("Show isolated prob.0 nodes",false);
	inferenceOptions.add(eliminateIsolatedZeroNodes);
	//	adaptiveSampling = new JCheckBoxMenuItem("sample adaptive",false);
	// inferenceOptions.add(adaptiveSampling);


	inferenceOptions.add(decMode);
	//	inferenceOptions.add(sampleOrd);

	optionsmenu.add(rbnSystems);
	optionsmenu.add(inferenceOptions);
	optionsmenu.add(itemForgetAll);
	itemForgetAll.setToolTipText( "Forget the locations of all external software dependencies, i.e. samiam, inflib, ace, etc." );
	mb.add(optionsmenu);
	setJMenuBar(mb);

	helpmenu.add(itemabout);
	mb.add(helpmenu);

	fileChooser.addChoosableFileFilter( myFilterRST = new Filter_rst() );
	fileChooser.addChoosableFileFilter( myFilterRBN = new Filter_rbn() );
	fileChooser.addChoosableFileFilter(new Filter_bif());
	fileChooser.addChoosableFileFilter(new Filter_net());
	fileChooser.addChoosableFileFilter(new Filter_dne());
	fileChooser.setAcceptAllFileFilterUsed( true );

	//actionlistener for loading ordered strucs
	loadOrdered.addActionListener( this );


	//actionlistener for loading sparserelstrucs from the file
	loadSparse.addActionListener( this );


	//actionlistener for loading rbn from the file (via browse-button)
	loadRBN.addActionListener( this );
	//keylistener for loading rbn from the file (via textfield)
	rbnfilename.addKeyListener( this );

	//actionlistener for choosing bn-output file (via browse-button)
	saveBN.addActionListener( this );


	//keylistener for for choosing bn-output file (via textfield)
	bnoutfilename.addKeyListener( this );

	//actionlistener for starting the Bavaria editor
	startBavaria.addActionListener( this );


	//actionlistener for constructing standard BN
	constructCPTBN.addActionListener( this );

	
	itemInvokeSamIam.addActionListener( this );
	itemForgetAll.addActionListener( this );

	//actionlistener for opening the evidence module
	evModule.addActionListener( this );

	javaBayes.addItemListener( this );

	hugin.addItemListener( this );

	netica.addItemListener( this );
	samiam.addItemListener( this );

	decnone.addItemListener( this );

		decstandard.addItemListener( this );
		decdet.addItemListener( this );
// 		ordforward.addItemListener( this );
// 		ordripple.addItemListener( this );
		querySpecific.addItemListener( this );
		evidenceConditioned.addItemListener( this );

	eliminateIsolatedZeroNodes.addItemListener( this );
	//	adaptiveSampling.addItemListener( this );
	layoutItem.addItemListener( this );

	//actionlistener for exiting the program
	exit.addActionListener( this );

	btnDebugAceCompile.addActionListener( this );

	itemabout.addActionListener( this );

	//creating the layout
	srcLabels.add(rstsrcLabel);
	srcLabels.add(rbnsrcLabel);
	srcLabels.add(bnoutLabel);

	rbnfilename.setBackground(Color.white);
	rbnInputFields.add(rbnfilename, BorderLayout.CENTER);
	rbnInputFields.add(loadRBN, BorderLayout.EAST);

	bnoutfilename.setBackground(Color.white);
	bnoutInputFields.add(bnoutfilename, BorderLayout.CENTER);
	bnoutInputFields.add(saveBN, BorderLayout.EAST);

	rstsrc.setForeground(Color.black);
	inputFields.add(rstsrc);
	inputFields.add(rbnInputFields);
	inputFields.add(bnoutInputFields);

	southPanel.add(srcLabels, BorderLayout.WEST);
	southPanel.add(inputFields, BorderLayout.CENTER);

	scrollPane.getViewport().add(messageArea);
	messageArea.setEditable(false);

	Container contentPane = this.getContentPane();
	contentPane.setLayout(new BorderLayout());
	contentPane.add(scrollPane, BorderLayout.CENTER);
	contentPane.add(southPanel, BorderLayout.SOUTH);


	//inner class for closing the window
	this.addWindowListener(
			       new WindowAdapter(){
				   public void windowClosing(WindowEvent e){
				       exitProgram();
				   }
			       }
			       );

	this.init();
    }

  public void actionPerformed( ActionEvent e ) {
		Object source = e.getSource();
		if( source  == loadOrdered ){
      if (!isBavariaOpen){
			  final JDialog sizewin      = new JDialog(Primula.this, true);
			  final JTextField sizeField = new JTextField(5);
			  JLabel sizeLabel           = new JLabel("Enter size: ");
			  JButton ok                 = new JButton("Ok");
			  JButton cancel             = new JButton("Cancel");

			  JPanel size                = new JPanel(new BorderLayout());
			  JPanel buttons             = new JPanel(new GridLayout(1, 2));

			  size.add(sizeLabel, BorderLayout.WEST);
			  size.add(sizeField, BorderLayout.CENTER);
			  buttons.add(ok);
			  buttons.add(cancel);

				ok.addActionListener(new ActionListener(){
					public void actionPerformed(ActionEvent e){
						try{
							int dom = (new Integer(sizeField.getText())).intValue();
								if (dom >= 1){
									if(inst.isEmpty() && queryatoms.isEmpty()){
										if(strucEdited){
											if(confirm(STRUCTURE_MODIFIED)){
												newOrdStruc(dom);
												sizewin.dispose();
											}
											else
												sizewin.dispose();
										}
										else{
											newOrdStruc(dom);
											sizewin.dispose();
										}
									}
									else{
										if(confirm(INST_AND_QUERIES_LOST)){
											if(strucEdited){
												if(confirm(STRUCTURE_MODIFIED)){
													newOrdStruc(dom);
													sizewin.dispose();
												}
												else
													sizewin.dispose();
											}
											else{
												newOrdStruc(dom);
												sizewin.dispose();
											}
										}
										else
											sizewin.dispose();
									}
								}
								else
									sizeField.setText("");
						}catch (Exception ex){
							sizeField.setText("");
						}
					}
				});
				cancel.addActionListener(new ActionListener(){
					public void actionPerformed(ActionEvent e){
						sizewin.dispose();
					}
				});

				Container contentPane = sizewin.getContentPane();
				contentPane.setLayout(new BorderLayout());
				contentPane.add(size, BorderLayout.CENTER);
				contentPane.add(buttons, BorderLayout.SOUTH);

				sizewin.pack();
				sizewin.setLocation(Primula.this.getLocation());
				sizewin.show();
			}
			else
				Primula.showMessage("Please, close the Bavaria window first");
		}
		else if( source == saveBN ){
			int value = fileChooser.showDialog(Primula.this, "Select");
			if (value == JFileChooser.APPROVE_OPTION){
			  bnoutfile = fileChooser.getSelectedFile();
			  bnoutfilename.setText(bnoutfile.getPath());
			}
		}
		else if( source == loadSparse ){
			//actionlistener for loading sparserelstrucs from the file
			if (!isBavariaOpen){
				fileChooser.setFileFilter( myFilterRST );
				int value = fileChooser.showDialog(Primula.this, "Load");
				if (value == JFileChooser.APPROVE_OPTION) {
					srsfile = fileChooser.getSelectedFile();
		      if(inst.isEmpty() && queryatoms.isEmpty()){
						if(strucEdited){
							if(confirm(STRUCTURE_MODIFIED))
								loadSparseRelFile(srsfile);
						}
						else
							loadSparseRelFile(srsfile);
					}
					else{
						if(confirm(INST_AND_QUERIES_LOST)){
							if(strucEdited){
								if(confirm(STRUCTURE_MODIFIED))
								  loadSparseRelFile(srsfile);
							}
							else
								loadSparseRelFile(srsfile);
						}
					}
				}
			}
			else
				Primula.showMessage("Please, close the Bavaria window first\nor use the Bavaria load command");
		}
		else if( source == loadRBN ){
	//actionlistener for loading rbn from the file (via browse-button)
			fileChooser.setFileFilter( myFilterRBN );
	 		int value = fileChooser.showDialog(Primula.this, "Load");
			if (value == JFileChooser.APPROVE_OPTION){
				loadRBNFunction(fileChooser.getSelectedFile());
			}
		}
		else if( source == startBavaria ){
	//actionlistener for starting the Bavaria editor
			//rst loaded from file
			if(rels != null && rels instanceof SparseRelStruc && !isBavariaOpen && srsfile != null){
				SparseRelStruc temp = (SparseRelStruc)rels;
				if(temp.getCoords().size() == 0)
					temp.createCoords();
				new Bavaria(temp, srsfile, Primula.this, strucEdited);
				isBavariaOpen = true;
				rstsrc.setText("Bavaria RelStruc Editor");
			}

			//not a rst file (ordstruc)
			else if (rels != null && rels instanceof OrdStruc){
				if(inst.isEmpty() && queryatoms.isEmpty()){
					rels = new SparseRelStruc();
					new Bavaria((SparseRelStruc)rels, Primula.this, strucEdited);
					isBavariaOpen = true;
					rstsrc.setText("Bavaria RelStruc Editor");
					if(isEvModuleOpen)
						evidenceModule.newElementNames();
				}
				else{
					if(confirm(INST_AND_QUERIES_LOST)){
						rels = new SparseRelStruc();
						new Bavaria((SparseRelStruc)rels, Primula.this, strucEdited);
						isBavariaOpen = true;
						rstsrc.setText("Bavaria RelStruc Editor");
						if(isEvModuleOpen)
							evidenceModule.newElementNames();
						else{
							inst.reset();
							queryatoms.reset();
						}
					}
				}
			}

			//rst file created in Bavaria
			else if (rels != null && rels instanceof SparseRelStruc && !isBavariaOpen && srsfile == null){
				new Bavaria((SparseRelStruc)rels, null, Primula.this, strucEdited);
				isBavariaOpen = true;
				rstsrc.setText("Bavaria RelStruc Editor");
			}

			//create a new rst file
			else if (rels == null && !isBavariaOpen){
				rels = new SparseRelStruc();
				new Bavaria((SparseRelStruc)rels, Primula.this, strucEdited);
				isBavariaOpen = true;
				rstsrc.setText("Bavaria RelStruc Editor");
			}
		}
		else if( source == constructCPTBN ){
	//actionlistener for constructing standard BN
			boolean nogo = false;
			String message = "";
			if (rbn == null){
				nogo = true;
				message = message + " Please load rbn first";
			}
			if (rels == null){
				nogo = true;
				message = message + " Please load RelStruc first";
			}
			if (rbn != null){
				if (!rbn.multlinOnly() & decomposemode != OPTION_NOT_DECOMPOSE){
					nogo = true;
					message = message + " Please choose decompose:none for rbn containing non multilinear comb. functions";
				}
			}
			if(!nogo){
				try {
				    BayesConstructor constructor = null;
				    if( bnsystem == OPTION_SAMIAM )
					constructor = new BayesConstructor(Primula.this ,
									   inst,
									   queryatoms,
									   makeNetworkName());

				    else constructor = new BayesConstructor(rbn,
									    rels,
									    inst,
						     queryatoms,
						     bnoutfile);
						constructor.constructCPTNetwork(evidencemode,
							querymode,
							decomposemode,
							isolatedzeronodesmode,
							layoutmode,
							bnsystem);
				}
				catch(RBNCyclicException ex) {Primula.showMessage(ex.toString());}
				catch(RBNCompatibilityException ex){Primula.showMessage(ex.toString());};
			}
			else Primula.showMessage(message);
		}
		else if( source == itemInvokeSamIam ){
			//SamiamUIInt ui = getSamIamUIInstanceThis();
			//if( ui != null ) ui.asJFrame().setVisible( true );
			getSamiamManager().openSamiam();
		}
		else if( source == itemForgetAll ){
			Primula.this.forgetAll();
		}
		else if( source == evModule ){
		    //actionlistener for opening the evidence module
		    if(!isEvModuleOpen){
			evidenceModule = new EvidenceModule(this
							    //inst,
							    //queryatoms,
							    //evidencemode,
							    //querymode,
							    //isolatedzeronodesmode,
							    //sampleordmode,
							    //adaptivemode,
							    //samplelogmode
              );
			isEvModuleOpen = true;
		    }
		}
		else if( source == exit ){
		    if(strucEdited){
				if(confirm(STRUCTURE_MODIFIED) == true)
					exitProgram();
			}
			else
				exitProgram();
		}
		else if( source == btnDebugAceCompile ){
			//String pathRST = "./blockmap_large.rst";
			//String pathRBN = "./randblock_trans.rbn";
			String pathRST = "./holmes_2.rst";
			String pathRBN = "./holmes_2.rbn";
			loadSparseRelFile( srsfile = new File( pathRST ) );
			loadRBNFunction(             new File( pathRBN ) );
			evModule.doClick();
			//evidenceModule.aceCompile();
			//evidenceModule.getACEControl().getActionCompile().actionPerformed( null );
		}
		else if( source == itemabout ){
		    JOptionPane.showMessageDialog(null,"Primula version 2.1" + '\n' + "(C) 2007");
		}
	}

 	public void keyPressed(KeyEvent e){
  //Invoked when a key has been pressed.
		Object source = e.getSource();
		if( source == rbnfilename ){
		   char c = e.getKeyChar();
		   if(c == KeyEvent.VK_ENTER){
	       loadRBNFunction(new File(rbnfilename.getText()));
		   }
	  }
		else if( source == bnoutfilename ){
			//keylistener for for choosing bn-output file (via textfield)
	    char c = e.getKeyChar();
	    if(c == KeyEvent.VK_ENTER){
				 bnoutfile = new File(bnoutfilename.getText());
	    }
		}
	}
 	public void keyReleased(KeyEvent e){
          //Invoked when a key has been released.
	}
 	public void keyTyped(KeyEvent e){
          //Invoked when a key has been typed.
	}


	//keylistener for loading rbn from the file (via textfield)
  public void itemStateChanged(ItemEvent e) {
		Object source = e.getSource();
		if( source == javaBayes ){
		  if (e.getStateChange() == ItemEvent.SELECTED)
	      bnsystem = OPTION_JAVABAYES;
	  }
		else if( source == hugin ){
      if (e.getStateChange() == ItemEvent.SELECTED)
			  bnsystem = OPTION_HUGIN;
	 	}
		else if( source == netica ){
	    if (e.getStateChange() == ItemEvent.SELECTED)
				bnsystem = OPTION_NETICA;
		}
		else if( source == samiam ){
      if (e.getStateChange() == ItemEvent.SELECTED)
				bnsystem = OPTION_SAMIAM;
		}
		else if( source == decnone ){
			if (e.getStateChange() == ItemEvent.SELECTED)
		    decomposemode = OPTION_NOT_DECOMPOSE;
		}
		else if( source == decstandard ){
	    if (e.getStateChange() == ItemEvent.SELECTED)
				decomposemode = OPTION_DECOMPOSE;
		}
		else if( source == decdet ){
			if (e.getStateChange() == ItemEvent.SELECTED)
				decomposemode = OPTION_DECOMPOSE_DETERMINISTIC;
	  }
//		else if( source == ordforward ){
//			if (e.getStateChange() == ItemEvent.SELECTED){
//				sampleordmode = OPTION_SAMPLEORD_FORWARD;
//				if(isEvModuleOpen)
//					evidenceModule.newSampleordMode(sampleordmode);
//			}
//		}
//		else if( source == ordripple ){
//		  if (e.getStateChange() == ItemEvent.SELECTED){
//		    sampleordmode = OPTION_SAMPLEORD_RIPPLE;
//		  	if(isEvModuleOpen)
//			  	evidenceModule.newSampleordMode(sampleordmode);
//			}
//		}
		else if( source == querySpecific){
      if (e.getStateChange() == ItemEvent.SELECTED)
			  querymode = OPTION_QUERY_SPECIFIC;
      else querymode = OPTION_NOT_QUERY_SPECIFIC;
		}
		else if( source == evidenceConditioned ){
	    if (e.getStateChange() == ItemEvent.SELECTED)
				evidencemode = OPTION_EVIDENCE_CONDITIONED;
	    else evidencemode = OPTION_NOT_EVIDENCE_CONDITIONED;
		}
		else if( source == eliminateIsolatedZeroNodes ) {
		   if (e.getStateChange() == ItemEvent.SELECTED)
		       isolatedzeronodesmode = OPTION_NOT_ELIMINATE_ISOLATED_ZERO_NODES;
		   else isolatedzeronodesmode = OPTION_ELIMINATE_ISOLATED_ZERO_NODES;
    }
//		else if( source == adaptiveSampling ){
//			if (e.getStateChange() == ItemEvent.SELECTED)
//				adaptivemode = OPTION_SAMPLE_ADAPTIVE;
//			else adaptivemode = OPTION_NOT_SAMPLE_ADAPTIVE;
//			if(isEvModuleOpen)
//			  evidenceModule.newAdaptiveMode(adaptivemode);
//		}
		else if( source == layoutItem ){
			if (e.getStateChange() == ItemEvent.SELECTED)
			   layoutmode = OPTION_NO_LAYOUT;
			else layoutmode = OPTION_LAYOUT;
		}

  }

    //creates a new ordered structure
    public void newOrdStruc(int dom){
	rels = new OrdStruc(dom);
	strucEdited = false;
	srsfile = null;
	if(isEvModuleOpen)
	    evidenceModule.newElementNames();
	else{
	    inst.reset();
	    queryatoms.reset();
	}
	rstsrc.setText("Ordered Structure size "+dom);
    }


    //loads the sparserel structure from file
    public void loadSparseRelFile(File srsfile){
	SparseRelStrucReader relreader = new SparseRelStrucReader();
	strucEdited = false;
	try{
	    Rel.resetTheColorCounters();
	    rels = relreader.readSparseRelStrucFromFile(srsfile.getPath());
	    rstsrc.setText(srsfile.getName());
	}catch (Exception ex){
	    rels = null;
	    srsfile = null;
	    rstsrc.setText("");
	    Primula.showMessage(ex.toString());
	}
	if(isEvModuleOpen)
	    evidenceModule.newElementNames();
	else{
	    inst.reset();
	    queryatoms.reset();
	}
    }


    //loads the rbn file
    public void loadRBNFunction(File input_file){
	RBNReader rbnrdr =  new RBNReader();

	if(inst.isEmpty() && queryatoms.isEmpty()){
	    try{
		rbn = new RBN(input_file.getPath());
		rbnfile = input_file;
		rbnfilename.setText(rbnfile.getPath());
	    }catch (Exception ex){
		rbn = null;
		rbnfile = null;
		rbnfilename.setText("");
		Primula.showMessage(ex.toString());
	    }
	    Rel.resetTheColorCounters();
	    if(isEvModuleOpen)
		evidenceModule.updateRBNRelations();
	}
	else{
	    if(confirm(INST_AND_QUERIES_LOST)){
		try{
		    rbn = new RBN(input_file.getPath());
		    rbnfile = input_file;
		    rbnfilename.setText(rbnfile.getPath());
		}catch (Exception ex){
		    rbn = null;
		    rbnfile = null;
		    rbnfilename.setText("");
		    Primula.showMessage(ex.toString());
		}
		Rel.resetTheColorCounters();
		if(isEvModuleOpen)
		    evidenceModule.updateRBNRelations();
		else{
		    inst.reset();
		    queryatoms.reset();
		}
	    }
	    else //replace the current text with the real filename
		rbnfilename.setText(rbnfile.getPath());
	}
    }


    /** @author Keith Cascio */
    public void showMessageThis(String message){
	showMessage( message );
    }

    /** @author Keith Cascio */
    public void appendMessageThis(String message){
	appendMessage( message );
    }

    /** @author Keith Cascio */
    public void setIsBavariaOpenThis(boolean b){
	setIsBavariaOpen( b );
    }

    /** @author Keith Cascio */
    public void setIsEvModuleOpenThis(boolean b){
	setIsEvModuleOpen( b );
    }

    //shows the messages
    public static void showMessage(String message){
	messageArea.append("\n"+message);
    }

    // without starting a newline:
    public static void appendMessage(String message){
	messageArea.append(message);
    }

    //sets the state of the Bavaria window
    public static void setIsBavariaOpen(boolean b){
	isBavariaOpen = b;
    }

//    public  int adaptivemode(){
//	return adaptivemode;
//    }

    //sets the state of the evidence module window
    public static void setIsEvModuleOpen(boolean b){
	isEvModuleOpen = b;
    }


    //sets the current rel struc
    public void setRelStruc(SparseRelStruc srel){
	rels = srel;
	if(isEvModuleOpen)
	    evidenceModule.newElementNames();
	else{
	    inst.reset();
	    queryatoms.reset();
	}
    }


    //sets the current input file
    public void setInputFile(File inputFile){
	if(inputFile == null)
	    srsfile = null;
	else
	    srsfile = inputFile;
    }


    //user adds or renames a node in the Bavaria window
    public void addOrRenameEvidenceModuleNode(){
	if(isEvModuleOpen)
	    evidenceModule.addOrRenameElementName();
    }


    //user deletes a node in the Bavaria window
    public void deleteElementFromEvidenceModule(int node){
	if(isEvModuleOpen)
	    evidenceModule.deleteElementName(node);
    }


    //ask confirmation
    public boolean confirm(String text){
	int result = JOptionPane.showConfirmDialog(this, text, "Confirmation", JOptionPane.YES_NO_OPTION);
	if (result == JOptionPane.YES_OPTION)
	    return true;
	else //result == JOptionPane.NO_OPTION
	    return false;
    }

    /** @author keith cascio
	@since 20061023 */
    public Instantiation getInstantiation(){
    	return this.inst;
    }

    /** @author keith cascio
	@since 20061023 */
    public boolean instContainsAll( Instantiation old ){
	if( inst == null ) return (old == null) || old.isEmpty();
	else               return inst.containsAll( old );
    }

    //returns true if the instantiation is empty (used by Bavaria)
    public boolean isInstEmpty(){
	return inst.isEmpty();
    }

    //returns true if the atomlist is empty (used by Bavaria)
    public boolean isQueryatomsEmpty(){
	return queryatoms.isEmpty();
    }

    //user has edited the structure in the Bavaria
    public void setStrucEdited(boolean b){
	strucEdited = b;
	if( isEvModuleOpen ) evidenceModule.relationalStructureEdited();//keith cascio 20060725
    }


    public int evidencemode(){
	return evidencemode;
    }

    /** Opens Bavaria with the current rels */
    public Bavaria openBavaria(){
	return new Bavaria(new SparseRelStruc(), Primula.this, strucEdited);
    }

    private void loadDefaults(){
	String rbninputfilestring = "/home/jaeger/B/Primula-Develop/New/Primula-beta/Examples/RBNinputs/distributed.rbn";
	String rstinputfilestring = "/home/jaeger/B/Primula-Develop/New/Primula-beta/Examples/RSTinputs/distributed_l.rst";

	srsfile = new File(rstinputfilestring);
	rbnfile = new File(rbninputfilestring);

	loadRBNFunction(rbnfile);
	loadSparseRelFile(srsfile);
	    
	

	//bnoutfile = new File("/home/jaeger/B/Primula-Develop/New/Primula/Examples-beta/Huginoutputs/distributed.net");
    }

    public static void main( String[] args ){
	//System.out.println( "classpath: \"" + System.getProperty( "java.class.path" ) + "\"" );
	//System.out.println( "library path: \"" + System.getProperty( "java.library.path" ) + "\"" );
	for( String arg : args ){
	    if( STR_OPTION_DEBUG.equals( arg ) ) FLAG_DEBUG = true;
	}

	Primula win = new Primula();
	SamiamManager.centerWindow( win );
	win.show();
	//win.loadDefaults();
    }
}
